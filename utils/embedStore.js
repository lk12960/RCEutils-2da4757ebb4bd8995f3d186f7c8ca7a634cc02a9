const db = require('../database/db');\n\nfunction listTemplates() {\n  return new Promise((resolve, reject) => {\n    db.all(`SELECT id, name FROM embed_templates ORDER BY updated_at DESC`, [], (err, rows) => {\n      if (err) return reject(err);\n      resolve(rows || []);\n    });\n  });\n}\n\nfunction getTemplate(id) {\n  return new Promise((resolve, reject) => {\n    db.get(`SELECT id, name, data FROM embed_templates WHERE id = ?`, [String(id)], (err, row) => {\n      if (err) return reject(err);\n      if (!row) return resolve(null);\n      try { row.data = JSON.parse(row.data); } catch {}\n      resolve(row);\n    });\n  });\n}\n\nfunction saveTemplate(id, name, data) {\n  return new Promise((resolve, reject) => {\n    const now = new Date().toISOString();\n    const json = JSON.stringify(data || {});\n    db.run(\n      `INSERT INTO embed_templates (id, name, data, created_at, updated_at) VALUES (?, ?, ?, ?, ?)\n       ON CONFLICT(id) DO UPDATE SET name = excluded.name, data = excluded.data, updated_at = excluded.updated_at`,\n      [String(id), String(name), json, now, now],\n      function (err) { if (err) return reject(err); resolve(true); }\n    );\n  });\n}\n\nfunction deleteTemplate(id) {\n  return new Promise((resolve, reject) => {\n    db.run(`DELETE FROM embed_templates WHERE id = ?`, [String(id)], function (err) {\n      if (err) return reject(err);\n      resolve(this.changes > 0);\n    });\n  });\n}\n\nfunction getReply(id) {\n  return new Promise((resolve, reject) => {\n    db.get(`SELECT id, text FROM embed_replies WHERE id = ?`, [String(id)], (err, row) => {\n      if (err) return reject(err);\n      resolve(row || null);\n    });\n  });\n}\n\nfunction saveReply(id, text) {\n  return new Promise((resolve, reject) => {\n    const now = new Date().toISOString();\n    db.run(\n      `INSERT INTO embed_replies (id, text, created_at, updated_at) VALUES (?, ?, ?, ?)\n       ON CONFLICT(id) DO UPDATE SET text = excluded.text, updated_at = excluded.updated_at`,\n      [String(id), String(text), now, now],\n      function (err) { if (err) return reject(err); resolve(true); }\n    );\n  });\n}\n\nfunction deleteReply(id) {\n  return new Promise((resolve, reject) => {\n    db.run(`DELETE FROM embed_replies WHERE id = ?`, [String(id)], function (err) {\n      if (err) return reject(err);\n      resolve(this.changes > 0);\n    });\n  });\n}\n\nmodule.exports = { listTemplates, getTemplate, saveTemplate, deleteTemplate, getReply, saveReply, deleteReply };\n